<script>
  $(document).ready(function () {
    $('#calendar').fullCalendar({
      defaultView: 'month',
      dayClick: function (date, jsEvent, view) {
        openAddLessonForm(date.format());
      },
      eventRender: function (event, element) {
        var studentInfo = event.student_info;
        if (element.find('.student-info').length === 0) {
          element.find('.fc-content').append('<span class="student-info">' + studentInfo + '</span>');
        }
      },
      eventClick: function (calEvent, jsEvent, view) {
        showLessonInformation(calEvent);
        return false;
      },

      header: {
        left: 'prev,next today',
        center: 'title',
        right: ''
      }
    });

    updateCalendarEvents();
  });

  function openAddLessonForm(date) {
    document.getElementById('lessonDate').value = date;
    document.getElementById('lessonType').value = '';
    document.getElementById('studentName').value = '';

    $('#addLessonPopup').show();
  }

  function closeAddLessonPopup() {
    $('#addLessonPopup').hide();
  }

  function closeLessonInfoPopup() {
    $('#lessonInfoPopup').hide();
  }

  function addLesson() {
    var date = $('#lessonDate').val();
    var lessonType = $('#lessonType').val();
    var studentName = $('#studentName').val();

    $.ajax({
      url: '/calendar',
      method: 'POST',
      data: JSON.stringify({
        title: lessonType,
        start_date: date,
        studentName: studentName
      }),
      contentType: 'application/json',
      success: function (response) {
        if (response.success) {
          alert('Lesson added successfully');

          var lessonId = response.lesson_id;
          var event = {
            title: lessonType,
            start: date + 'T12:00:00',
            allDay: true,
            id: lessonId,
            student_info: studentName
          };

          $('#calendar').fullCalendar('renderEvent', event, true);
          updateLocalStorage(event);

        } else {
          alert('Error adding lesson');
        }
      }
    });

    closeAddLessonPopup();
  }

  function showLessonInformation(calEvent) {
    $('#infoLessonDate').text(calEvent.start.format('YYYY-MM-DD'));
    $('#infoLessonType').text(calEvent.title);
    $('#infoStudentName').text(calEvent.student_info);

    $('#infoLessonId').text(calEvent.id);

    $('#lessonInfoPopup').show();
  }

  function updateLocalStorage(event) {
    var calendarEvents = JSON.parse(localStorage.getItem('calendarEvents')) || [];
    calendarEvents.push(event);
    localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
  }

  function updateCalendarEvents() {
    var calendarEvents = JSON.parse(localStorage.getItem('calendarEvents')) || [];
    $('#calendar').fullCalendar('removeEvents');

    calendarEvents.forEach(function (event) {
      $('#calendar').fullCalendar('renderEvent', event, true);
    });
  }

  function removeEventFromLocalStorage(eventToRemove) {
    var calendarEvents = JSON.parse(localStorage.getItem('calendarEvents')) || [];
    calendarEvents = calendarEvents.filter(function (event) {
      return eventToRemove._id !== event._id;
    });

    localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
  }

  function deleteLessonFromLocalStorage(lessonId) {
    var calendarEvents = JSON.parse(localStorage.getItem('calendarEvents')) || [];
    calendarEvents = calendarEvents.filter(function (event) {
      return event.id !== lessonId;
    });

    localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
  }

  function deleteLesson() {
    var lessonId = $('#infoLessonId').text();
    var date = $('#infoLessonDate').text();
    var lessonType = $('#infoLessonType').text();
    var studentName = $('#infoStudentName').text();

    $.ajax({
      url: '/delete_lesson',
      method: 'POST',
      data: JSON.stringify({
        lesson_id: lessonId
      }),
      contentType: 'application/json',
      success: function (response) {
        if (response.success) {
          alert('Lesson deleted successfully');

          // Remove the event from localStorage
          deleteLessonFromLocalStorage(lessonId);

          // Remove the event from the calendar
          $('#calendar').fullCalendar('removeEvents', lessonId);

        } else {
          alert('Error deleting lesson');
        }
      }
    });

    closeLessonInfoPopup();
  }
</script>
